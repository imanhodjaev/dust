defmodule Dust.Loaders.CSS.Inliner do
  @moduledoc """
  This module works with CSS and provides
  API to inline all images as base64 encoded
  values, this however does not include fonts.
  """
  alias ExImageInfo, as: Image
  alias Dust.Parsers
  alias Dust.Requests
  alias Dust.Requests.ClientState

  @css_url_regex ~r/url\(['"]?(?<uri>.*?)['"]?\)/

  @type css_content() :: binary()

  @doc """
  Extract all `url(â€¦)` values, fetch, base64 encode and inline.
  Fonts however are not included.
  """
  @spec inline(css_content(), ClientState.t()) :: binary()
  def inline(css_content, client) do
    base_url = Parsers.URI.get_base_url(client.full_url)

    inline_sources =
      @css_url_regex
      |> Regex.scan(css_content)
      |> Enum.map(&Enum.at(&1, 1))
      |> Enum.reject(&Parsers.URI.is_data_url?/1)
      |> Enum.reject(&Parsers.URI.is_font?/1)
      |> Enum.map(&{&1, Parsers.URI.expand(base_url, &1)})
      |> Enum.map(&fetch(&1, client.options))
      |> Enum.map(&Task.await/1)

    Enum.reduce(inline_sources, css_content, fn source, replaced ->
      replace(source, replaced)
    end)
  end

  defp fetch({relative_url, absolute_url}, options) do
    Task.async(fn ->
      {relative_url, Requests.get(absolute_url, options)}
    end)
  end

  defp replace({url, {:ok, result, _client}}, inline_to) do
    cond do
      String.ends_with?(url, ".svg") ->
        String.replace(
          inline_to,
          url,
          "data:image/svg+xml;base64,#{Base.encode64(result.content)}"
        )

      true ->
        String.replace(
          inline_to,
          url,
          encode(result.content)
        )
    end
  end

  defp replace({_url, {:error, _result, _client}}, inline_to) do
    inline_to
  end

  defp encode(asset) do
    case Image.type(asset) do
      {mime, _variant} ->
        "data:#{mime};base64,#{Base.encode64(asset)}"
      _ ->
        "data:image/png;base64,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"
    end
  end
end
